<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Store Performance Command Center</title>
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        body { font-family: 'Inter', sans-serif; transition: background 0.6s ease-in-out; overscroll-behavior: none; background-color: #f0f4f8; }
        .card { transition: all 0.35s ease; border: 1px solid #e2e8f0; background-color: white; border-radius: 0.8rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .card:hover { transform: translateY(-6px); box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.05); border-color: #a5b4fc; }
        .chart-container { position: relative; width: 100%; overflow: hidden; }
        .combo-chart-container { height: 380px; }
        .pie-chart-container { height: 320px; }
        .comparison-chart-container { height: 350px; }
        .heatmap-scrollable { max-height: 320px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #94a3b8 #e2e8f0; }
        .heatmap-scrollable::-webkit-scrollbar { width: 8px; }
        .heatmap-scrollable::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .heatmap-scrollable::-webkpi-card:hover::after { opacity: 1; animation: shimmer 3s infinite linear; }
        @keyframes shimmer { 0% { transform: rotate(0deg) translateX(-100%); } 100% { transform: rotate(0deg) translateX(100%); }}
        .kpi-value { font-size: 2.75rem; font-weight: 800; line-height: 1.1; margin-bottom: 0.5rem; transition: color 0.3s ease;}
        .kpi-label { font-size: 0.8rem; color: #475569; letter-spacing: 0.8px; font-weight: 600; text-transform: uppercase; }
        .bg-status-good { background-color: #f0fdf4 !important; } .bg-status-ok { background-color: #eff6ff !important; } .bg-status-warn { background-color: #fffbeb !important; } .bg-status-alert { background-color: #fef2f2 !important; }
        .insight-block { margin-bottom: 1.25rem; padding: 1rem 1.3rem; border-radius: 0.75rem; border: 1px solid transparent; transition: background-color 0.3s ease; }
        .insight-block h4 { font-size: 1.05rem; font-weight: 700; margin-bottom: 0.6rem; display: flex; align-items: center; gap: 0.5rem; color: #1e293b; }
        .metric-list { list-style: none; padding-left: 0; margin: 0.4rem 0 0 0; }
        .metric-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; font-size: 0.9rem; border-bottom: 1px dotted #d1d5db; }
        .metric-list li:last-child { border-bottom: none; }
        .metric-list span:first-child { color :esque; border: 1px solid #e2e8f0; transition: all 0.3s ease-out; position: relative; overflow: hidden;}
        .kpi-card::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%); transform: rotate(45deg); transition: opacity 0.5s ease; opacity: 0;}
        .kpi-card:hover::after { opacity: 1; animation: shimmer 3s infinite linear; }
        @keyframes shimmer { 0% { transform: rotate(0deg) translateX(-100%); } 100% { transform: rotate(0deg) translateX(100%); }}
        .kpi-value { font-size: 2.75rem; font-weight: 800; line-height: 1.1; margin-bottom: 0.5rem; transition: color 0.3s ease;}
        .kpi-label { font-size: 0.8rem; color: #475569; letter-spacing: 0.8px; font-weight: 600; text-transform: uppercase; }
        .bg-status-good { background-color: #f0fdf4 !important; } .bg-status-ok { background-color: #eff6ff !important; } .bg-status-warn { background-color: #fffbeb !important; } .bg-status-alert { background-color: #fef2f2 !important; }
        .insight-block { margin-bottom: 1.25rem; padding: 1rem 1.3rem; border-radius: 0.75rem; border: 1px solid transparent; transition: background-color 0.3s ease; }
        .insight-block h4 { font-size: 1.05rem; font-weight: 700; margin-bottom: 0.6rem; display: flex; align-items: center; gap: 0.5rem; color: #1e293b; }
        .metric-list { list-style: none; padding-left: 0; margin: 0.4rem 0 0 0; }
        .metric-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; font-size: 0.9rem; border-bottom: 1px dotted #d1d5db; }
        .metric-list li:last-child { border-bottom: none; }
        .metric-list span:first-child { color: #334155; margin-right: 0.75rem;}
        .metric-list .percentage { font-weight: 700; font-size: 1rem; }
        .advice { font-size: 0.95rem; line-height: 1.65; color: #334155; margin-top: 0.8rem; }
        .incentive-gap { font-weight: 700; font-size: 1.1rem; }
        .filter-label { font-size: 0.875rem; font-weight: 500; color: #475569; margin-right: 0.5rem;}
        select { border: 1px solid #cbd5e1; padding: 0.5rem 0.75rem; border-radius: 0.375rem; background-color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 0.875rem; transition: border-color 0.2s ease, box-shadow 0.2s ease;}
        select[multiple] { padding: 0.5rem; height: 100px;} /* Style multi-select */
        select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        .exec-summary { padding: 1rem; border-radius: 0.75rem; font-size: 1.05rem; line-height: 1.6; }
        .kpi-good { color: #059669; } .kpi-ok { color: #2563eb; } .kpi-warn { color: #d97706; } .kpi-alert { color: #dc2626; }
        .chartjs-tooltip { opacity: 1; position: absolute; background: rgba(17, 24, 39, 0.9); color: white; border-radius: 6px; padding: 8px 12px; font-size: 12px; pointer-events: none; transition: all .15s ease; z-index: 10; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .chartjs-tooltip-key { display: inline-block; background-color: var(--color); width: 10px; height: 10px; margin-right: 6px; border-radius: 3px; vertical-align: middle; }
        .tooltip-title { font-weight: 700; margin-bottom: 4px; font-size: 13px;}
        .tooltip-body li { margin-bottom: 3px;}
        .tooltip-body li:last-child { margin-bottom: 0;}
        .selected-store-note { font-size: 0.75rem; color: #475569; text-align: center; margin-top: -0.5rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-100">
  <div class="max-w-7xl mx-auto space-y-7">
    <header class="text-center mb-6">
        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 flex items-center justify-center flex-wrap">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-3 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            Executive Command Center <span class="pro-badge animate-pulse">Pro</span>
        </h1>
        <p class="text-lg text-gray-600 mt-3">Monitor Performance, Drive Strategy</p>
    </header>

     <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4 sticky top-2 z-20 backdrop-filter backdrop-blur-md bg-opacity-85">
        <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
             <label class="filter-label" for="excelFile">Load Data:</label>
             <input type="file" id="excelFile" accept=".xlsx, .xls" class="block text-sm text-gray-500 file:mr-3 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer transition"/>
             <span class="border-l border-gray-300 h-6 hidden sm:inline-block mx-2"></span>
             <label class="filter-label" for="asmSelector">ASM:</label>
             <select id="asmSelector" class="min-w-[180px]" disabled><option value="">-- Load Data First --</option></select>
             <label class="filter-label" for="storeSelector">Store(s):</label>
             <select id="storeSelector" class="min-w-[200px]" multiple size="5" disabled><option value="">-- Select ASM First --</option></select>
         </div>
        <button id="exportReport" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 transition-colors duration-200 text-sm font-medium shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 flex items-center gap-2 whitespace-nowrap mt-2 sm:mt-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a5 5 0 00-5 5v3H4a2 2 0 00-2 2v5a2 2 0 002 2h12a2 2 0 002-2v-5a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm0 2.5a2.5 2.5 0 012.5 2.5V7h-5V7a2.5 2.5 0 012.5-2.5z" /></svg>
          Generate PDF
        </button>
     </div>

     <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-5">
        <div class="kpi-card"> <div id="kpi-overall-achieved" class="kpi-value">-</div> <div class="kpi-label">Overall vs Target (%)</div> </div>
        <div class="kpi-card"> <div id="kpi-predicted-achieved" class="kpi-value">-</div> <div class="kpi-label">EoM Projection (%)</div> </div>
        <div class="kpi-card"> <div id="kpi-incentive" class="kpi-value">-</div> <div class="kpi-label">Current Potential Incentive</div> </div>
     </div>
     <div id="selected-store-note" class="selected-store-note hidden"></div>

    <div id="multi-store-comparison" class="hidden">
         <div class="card p-6 mb-6">
            <h2 class="text-lg font-semibold mb-3 text-gray-800 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                 Multi-Store Comparison: Overall Achievement (%)
             </h2>
             <div class="chart-container comparison-chart-container">
                 <canvas id="comparisonChart"></canvas>
             </div>
         </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
         <div class="lg:col-span-3 card p-6">
             <h2 class="text-lg font-semibold mb-3 text-gray-800 flex items-center gap-2">
                 <svg class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                 Core Metrics Performance (Excl. UPI)
             </h2>
             <div class="chart-container combo-chart-container"><canvas id="comboChart"></canvas></div>
         </div>
         <div class="lg:col-span-2 space-y-6">
             <div class="card p-6">
                 <h2 class="text-lg font-semibold mb-3 text-gray-800 flex items-center gap-2">
                    <svg class="h-5 w-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11 15a4 4 0 11-8 0 4 4 0 018 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-1.5 1.5m1.5-1.5V21a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2.5m8 0l1.5 1.5M3 15V8a2 2 0 012-2h4a2 2 0 012 2v7m3-7h4a2 2 0 012 2v2.5m-8 0l-1.5-1.5m1.5 1.5L11 13" /></svg>
                     Contribution Mix (Excl. UPI)
                  </h2>
                <div class="chart-container pie-chart-container"><canvas id="pieChart"></canvas></div>
             </div>
             <div class="card p-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-800 flex items-center gap-2">
                    <svg class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>
                    Achievement Detail
                 </h2>
                <div id="heatmap" class="heatmap-scrollable"></div>
             </div>
         </div>
    </div>

     <div class="card p-6 lg:p-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-900 flex items-center gap-3">
           <svg class="h-6 w-6 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            Performance Analysis & Strategic Focus <span id="analysis-store-name" class="text-base text-gray-500 font-normal"></span>
        </h2>
         <div id="prediction" class="space-y-1 text-sm text-gray-800"></div>
         <p class="text-xs text-gray-400 mt-6 text-center">Analysis based on current data trends. External factors may influence final results.</p>
     </div>

    <div id="summary" style="display:none;"></div>
  </div>

    <div id="tooltip-container"></div>

  <script>
    // --- Global Variables ---
    let parsedData = {};
    let asms = [];
    let currentChart = null;
    let pieChartInstance = null;
    let comparisonChartInstance = null;
    const { jsPDF } = window.jspdf;
    const chartFilter = "UPI SALES"; // Metric to exclude from charts

    // --- Helper Functions (Defined First) ---

    // Debounce function to limit event handler calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => { clearTimeout(timeout); func.apply(this, args); };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Cleans raw data array values (handles commas, symbols, '-', '%', null/undefined)
    function cleanData(arr) {
         if (!Array.isArray(arr)) return 0; // Return 0 for invalid array itself
         return arr.map(v => {
              if (v == null || String(v).trim() === '' || String(v).trim() === '-') return 0; // Treat null, empty, hyphen as 0
              const strVal = String(v);
              const cleanedVal = strVal.replace(/[,₹$]/g, '').trim();
              if (cleanedVal.endsWith('%')) { const num = parseFloat(cleanedVal.slice(0, -1)); return isNaN(num) ? 0 : num; }
              const num = parseFloat(cleanedVal);
              return isNaN(num) ? 0 : num; // Default to 0 if not a valid number after cleaning
          });
      }

    // Function to create a linear gradient for chart bars
     function createGradient(ctx, color1, color2) {
         const gradient = ctx.createLinearGradient(0, 0, 0, 400); // Adjust 400 based on chart height
         gradient.addColorStop(0, color1);
         gradient.addColorStop(1, color2);
         return gradient;
     }

     // Get or create a custom HTML div for the tooltip
     const getOrCreateTooltip = (chart) => {
         let tooltipContainer = chart.canvas.parentNode.querySelector('#tooltip-container');
         if (!tooltipContainer) { tooltipContainer = document.createElement('div'); tooltipContainer.id = 'tooltip-container'; chart.canvas.parentNode.appendChild(tooltipContainer); }
         let tip = tooltipContainer.querySelector('.chartjs-tooltip');
         if (!tip) { tip = document.createElement('div'); tip.classList.add('chartjs-tooltip'); tip.style.opacity = 0; tip.style.pointerEvents = 'none'; tooltipContainer.appendChild(tip); }
         return tip;
     };

    // Handler function for Chart.js external tooltips
    const externalTooltipHandler = (context) => {
        const { chart, tooltip } = context; const tooltipEl = getOrCreateTooltip(chart);
        if (tooltip.opacity === 0) { tooltipEl.style.opacity = 0; return; }
        let innerHtml = '';
        if (tooltip.title && tooltip.title.length > 0) { innerHtml += `<div class="tooltip-title">${tooltip.title[0]}</div>`; }
        innerHtml += '<ul class="tooltip-body">';
        tooltip.body.forEach((bodyItem) => {
             // Safely access color based on dataset index - ADDED SAFETY CHECK
            const colors = tooltip.labelColors && tooltip.labelColors[bodyItem.datasetIndex] ? tooltip.labelColors[bodyItem.datasetIndex] : { backgroundColor: '#ccc', borderColor: '#888' };
            const style = `background: ${colors.backgroundColor}; border: 1px solid ${colors.borderColor};`;
            const lines = bodyItem.lines; innerHtml += `<li><span class="chartjs-tooltip-key" style="${style}"></span>${lines.join(': ')}</li>`;
        }); innerHtml += '</ul>';
        tooltipEl.innerHTML = innerHtml;
        const { offsetLeft: chartLeft, offsetTop: chartTop } = chart.canvas; const canvasRect = chart.canvas.getBoundingClientRect(); const tooltipRect = tooltipEl.getBoundingClientRect();
        let left = chartLeft + tooltip.caretX - (tooltipRect.width / 2); let top = chartTop + tooltip.caretY - tooltipRect.height - 10;
         // Adjust positioning logic
         if (left + tooltipRect.width > chartLeft + chart.width) left = chartLeft + chart.width - tooltipRect.width;
         if (left < chartLeft) left = chartLeft;
         if (top + tooltipRect.height > chartTop + chart.height) top = chartTop + chart.height - tooltipRect.height;
         if (top < chartTop) top = chartTop;


        tooltipEl.style.left = left + 'px'; tooltipEl.style.top = top + 'px'; tooltipEl.style.opacity = 1;
    };

    // Determines the background and text color for heatmap cells based on percentage
     function getHeatmapClr(pct) {
        let bgColor, textColor = '#1f2937';
        if (pct === Infinity) { bgColor = 'rgba(16, 185, 129, 0.6)'; textColor = '#047857'; } // Achieved > 0, Target = 0
        else{ pct = parseFloat(pct); if (isNaN(pct)) bgColor = 'rgba(241, 245, 249, 0.8)'; // Invalid/No data
             else if (pct >= 200) { bgColor = 'rgba(5, 150, 105, 0.6)'; } // Darker Green
             else if(pct >= 120) { bgColor = 'rgba(16, 185, 129, 0.45)'; } // Green
             else if(pct >= 100) { bgColor = 'rgba(16, 185, 129, 0.3)'; } // Lighter Green
             else if(pct >= 90) { bgColor = 'rgba(199, 210, 254, 0.8)'; } // Light Blue
             else if(pct >= 75) { bgColor = 'rgba(254, 249, 195, 0.85)'; } // Light Yellow
             else if(pct >= 50) { bgColor = 'rgba(254, 226, 226, 0.9)'; textColor = '#b91c1c'; } // Light Red (with dark text)
             else { bgColor = 'rgba(254, 202, 202, 1)'; textColor = '#991b1b';} // Red (with dark text)
         }
        return { bg: bgColor, text: textColor }; // Return object with both colors
    }

     // Sets the body background color based on overall performance percentage
     function setPerformanceBackground(percentage) {
         document.body.classList.remove('bg-status-good','bg-status-ok','bg-status-warn','bg-status-alert');
         let gradient = 'linear-gradient(135deg, #f8fafc, #e2e8f0)'; // Default neutral gray background
         let pulseClass = '';

         if (percentage === null || isNaN(percentage)) { // Handle invalid data state
            gradient = 'linear-gradient(135deg, #fee2e2 30%, #fef3c7 100%)'; // Muted Error gradient (Red to Yellow)
         }
         else if (percentage === Infinity || percentage >= 100) {
             gradient = 'linear-gradient(135deg, #dcfce7 30%, #bbf7d0 100%)'; // Greenish
             pulseClass = 'bg-status-good';
         } else if (percentage >= 90) {
             gradient = 'linear-gradient(135deg, #dbeafe 30%, #bfdbfe 100%)'; // Bluish
             pulseClass = 'bg-status-ok';
         } else if (percentage >= 60) {
             gradient = 'linear-gradient(135deg, #fef3c7 30%, #fde68a 100%)'; // Yellowish
             pulseClass = 'bg-status-warn';
         } else {
             gradient = 'linear-gradient(135deg, #fee2e2 30%, #fecaca 100%)'; // Reddish
             pulseClass = 'bg-status-alert';
         }

         document.body.style.background = gradient; // Apply the determined gradient
         if (pulseClass) { document.body.classList.add(pulseClass); } // Add the pulse class if determined
     }


    // Clears all data display sections and optionally selectors
     function clearDisplayAreas(clearSelectors = false) {
         document.getElementById('prediction').innerHTML = '<p class="text-center p-4 text-gray-500">Select ASM & Store(s) to view data.</p>';
         document.getElementById('heatmap').innerHTML = '';
         document.getElementById('analysis-store-name').textContent = ''; // Clear store name in analysis title
         document.getElementById('multi-store-comparison').classList.add('hidden'); // Hide comparison chart section
         document.getElementById('selected-store-note').classList.add('hidden'); // Hide multiple selection note

          // Destroy charts if they exist
          if (currentChart) { currentChart.destroy(); currentChart = null; }
          if (pieChartInstance) { pieChartInstance.destroy(); pieChartInstance = null; }
          if (comparisonChartInstance) { comparisonChartInstance.destroy(); comparisonChartInstance = null; }

           // Reset KPI cards
           ['kpi-overall-achieved', 'kpi-predicted-achieved', 'kpi-incentive'].forEach(id => {
             const el = document.getElementById(id);
             el.textContent = '-'; // Set text to hyphen
             el.className = 'kpi-value'; // Reset color class
         });

         // Reset background only if not clearing selectors (which implies data load failed or just started)
         if (clearSelectors) {
             document.getElementById('asmSelector').value = ""; // Reset ASM dropdown
             document.getElementById('storeSelector').innerHTML = '<option value="">-- Select ASM First --</option>'; // Reset store dropdown
             document.getElementById('storeSelector').disabled = true; // Disable store dropdown
              setPerformanceBackground(null); // Reset background to default/error
         } else {
            // Background status is already handled by displayData if data is loaded,
            // but if only charts are cleared due to filter, the background should persist
             // setPerformanceBackground(null); // Could reset to neutral here, depends on desired UX
         }
     }


    // --- Data Parsing ---

    // Event listener for the file input change
    document.getElementById('excelFile').addEventListener('change', function (e) {
        const file = e.target.files[0]; if (!file) return;

        // Get references to selectors and data display areas
        const asmSel = document.getElementById('asmSelector'), storeSel = document.getElementById('storeSelector');
        const pEl = document.getElementById('prediction'); // Only prediction needed here for error messages

        // Reset UI and show loading state
        asmSel.innerHTML = '<option value="">Loading Data...</option>'; asmSel.disabled = true;
        storeSel.innerHTML = '<option value="">Loading Data...</option>'; storeSel.disabled = true;
        clearDisplayAreas(false); // Clear existing data views but keep selectors reset handled next

        pEl.innerHTML = '<p class="text-center p-4 text-gray-500">Processing Excel Data...</p>';

        // Read and parse the Excel file
        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Reset global parsed data and ASMs
                parsedData = {};
                asms = [];

                // Process the first sheet found
                const firstSheetName = workbook.SheetNames[0];
                if (firstSheetName) {
                    const sheet = workbook.Sheets[firstSheetName];
                    // Check if sheet has data reference
                    if (sheet && sheet['!ref']) {
                         const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null, blankrows: false });
                        if (json.length > 1) { parseSheet(json); } else { console.warn("Sheet is empty."); }
                    } else { console.warn("Sheet is invalid."); }
                } else { console.error("Workbook contains no sheets."); }

                // After parsing all relevant sheets, update the UI selectors
                if (asms.length > 0) {
                    updateAsmSelector();
                    pEl.innerHTML = '<p class="text-center p-4 text-gray-500">Data loaded. Select ASM & Store(s).</p>'; // Update message
                } else {
                    // Handle case where no ASMs/stores were found during parsing
                     const errorMsg = 'Parsing complete, but failed to find valid store data blocks. Please verify your Excel file structure: Row 1 must contain "KAM", "BRANCH", "ASM", and "THINGS" headers followed by metrics. Data blocks should start with \'TARGET\' in the "THINGS" column, with Store and ASM names on that same row. See console for debug details.';
                     console.error(errorMsg);
                     asmSel.innerHTML = '<option value="">No Data Found</option>'; storeSel.innerHTML = '<option value="">No Data Found</option>';
                    asmSel.disabled = true; storeSel.disabled = true;
                    pEl.innerHTML = `<p class="text-center p-4 text-red-600 font-medium bg-red-50 border border-red-200 rounded">${errorMsg}</p>`;
                    setPerformanceBackground(null); // Reset or indicate error background
                }
            } catch (error) {
                // Handle errors during parsing or UI update after parse
                console.error("Excel Processing Error:", error);
                const errorMsg = `Error processing file: ${error.message}. Please ensure it's a valid Excel file with the expected structure.`;
                asmSel.innerHTML = '<option value="">Error</option>'; storeSel.innerHTML = '<option value="">Error</option>';
                asmSel.disabled = true; storeSel.disabled = true;
                pEl.innerHTML = `<p class="text-center p-4 text-red-600">${errorMsg}</p>`;
                setPerformanceBackground(null); // Reset or indicate error background
            }
        };

        // Handle errors during the file reading process
        reader.onerror = function (error) {
            console.error("FileReader Error:", error);
             const errorMsg = 'Error reading the file. It might be corrupted or inaccessible.';
             asmSel.innerHTML = '<option value="">Error</option>'; storeSel.innerHTML = '<option value="">Error</option>';
             asmSel.disabled = true; storeSel.disabled = true;
            pEl.innerHTML = `<p class="text-center p-4 text-red-600">${errorMsg}</p>`;
            setPerformanceBackground(null); // Reset or indicate error background
        };

        reader.readAsArrayBuffer(file); // Start reading the file as an Array Buffer
    });

    // Parse sheet data into structured parsedData object { asm: { store: { ... } } }
    function parseSheet(rows) {
        console.log("[DEBUG PARSE] Starting parseSheet with rows:", rows.length);
        const hdrIdx = 0; // Assuming Header is the very first row (row 1 in Excel)
        if (!rows[hdrIdx] || rows[hdrIdx].length < 5) { console.error("[DEBUG PARSE] Header row missing or too short (<5 columns)."); return; }

        // Dynamically find the column indices for required headers (case-insensitive)
        const headerRow = rows[hdrIdx];
        const kamIdx = headerRow.findIndex(h => h != null && String(h).trim().toUpperCase() === 'KAM');
        const branchIdx = headerRow.findIndex(h => h != null && String(h).trim().toUpperCase() === 'BRANCH');
        const asmIdx = headerRow.findIndex(h => h != null && String(h).trim().toUpperCase() === 'ASM');
        const thingsIdx = headerRow.findIndex(h => h != null && String(h).trim().toUpperCase() === 'THINGS');

         console.log(`[DEBUG PARSE] Found Header Indices: KAM:${kamIdx}, BRANCH:${branchIdx}, ASM:${asmIdx}, THINGS:${thingsIdx}`);

         // Check if all mandatory headers were found and if there's at least one column after THINGS for metrics
        if (kamIdx === -1 || branchIdx === -1 || asmIdx === -1 || thingsIdx === -1 || thingsIdx >= headerRow.length -1) {
            console.error(`[DEBUG PARSE] One or more mandatory headers missing OR no metric columns found after THINGS.`);
            console.log("[DEBUG PARSE] Full Header Row Content:", headerRow);
            return;
        }

        // Metric headers start from the column *after* THINGS
        const firstMetricIdx = thingsIdx + 1;
        const hdrs = headerRow.slice(firstMetricIdx).filter(h => h != null && String(h).trim() !== '');

        if (hdrs.length === 0) { console.error("[DEBUG PARSE] No valid metric headers found after the THINGS column."); return; }
        console.log("[DEBUG PARSE] Extracted Metric Headers:", hdrs);

        // Loop through rows, starting after the header row
        for (let i = 1; i < rows.length; i++) {
            // Check if the current row exists and its value in the 'THINGS' column is 'TARGET' (case-insensitive)
            if (rows[i] && rows[i][thingsIdx] != null && String(rows[i][thingsIdx]).trim().toUpperCase() === 'TARGET') {
                const row = rows[i]; // Current TARGET row
                 const currentRowNum = i + 1; // Excel row number (1-based)

                // Extract ASM and Store names from the specific columns found above
                const storeName = row[branchIdx] ? String(row[branchIdx]).trim() : null;
                const asmName = row[asmIdx] ? String(row[asmIdx]).trim() : "Unassigned ASM"; // Use "Unassigned ASM" if cell is empty

                // Validate minimum requirements for a block
                if (!storeName) {
                     console.warn(`[DEBUG PARSE] Row ${currentRowNum}: Found 'TARGET' but missing Branch name. Skipping this potential block.`);
                     continue; // Skip block if no store name
                }
                 // Check if there are enough subsequent rows for the full block structure (TARGET, INS-T, ACHIEVED, %, INS-WillGet!)
                if (i + 4 >= rows.length) {
                     console.warn(`[DEBUG PARSE] Row ${currentRowNum}: Found 'TARGET' for "${storeName}", but sheet ends before a complete 5-row block can be read.`);
                     continue; // Can't process if rows are missing
                }

                // --- Verify the structure of the next 4 rows based on labels in the 'THINGS' column ---
                const nextRows = rows.slice(i + 1, i + 5);
                // Ensure all 4 rows exist and have the THINGS column value matching expected labels
                const structOk = nextRows.length === 4 &&
                                (nextRows[0]?.[thingsIdx]?.toString().trim().toUpperCase() === 'INS - T') &&
                                (nextRows[1]?.[thingsIdx]?.toString().trim().toUpperCase() === 'ACHIEVED') &&
                                (nextRows[2]?.[thingsIdx]?.toString().trim().toUpperCase() === '%') &&
                                (nextRows[3]?.[thingsIdx]?.toString().trim().toUpperCase() === 'INS - WILL GET!');

                if (structOk) {
                    // --- Structure is valid, extract the metric data for this store block ---
                    const getMetricRowData = (rowIndex) => {
                        const targetRow = rows[rowIndex] || [];
                        const metricData = targetRow.slice(firstMetricIdx);
                        while (metricData.length < hdrs.length) { metricData.push(null); }
                        return metricData;
                    };

                     // Create the object structure for the store's data
                    const storeDataObj = {
                        TARGET: getMetricRowData(i),
                        'INS - T': getMetricRowData(i + 1),
                        ACHIEVED: getMetricRowData(i + 2),
                        'INS - Will Get!': getMetricRowData(i + 4),
                        HEADERS: hdrs, // Attach the extracted headers to this store's data block
                        KAM: row[kamIdx] ? String(row[kamIdx]).trim() : 'N/A' // Also store KAM
                    };

                    // Store the data within the nested parsedData structure: parsedData[ASM][Store] = dataObject
                    if (!parsedData[asmName]) { parsedData[asmName] = {}; } // Initialize ASM object if it's the first store for this ASM
                    if (!parsedData[asmName][storeName]) {
                         parsedData[asmName][storeName] = storeDataObj;
                         // Add ASM to unique list if not already present
                        if (!asms.includes(asmName)) { asms.push(asmName); }
                         // console.log(`[DEBUG PARSE] Parsed block: ASM "${asmName}", Store "${storeName}" (Row ${currentRowNum})`); // Log every success
                    } else {
                        console.warn(`[DEBUG PARSE] Duplicate block found for ASM: ${asmName}, Store: ${storeName} (Row ${currentRowNum}). Skipping.`);
                    }

                    // *** Advance loop index past this successfully processed 5-row block ***
                    i += 4;

                } else {
                    // Structure check failed for this potential block start
                    console.warn(`[DEBUG PARSE] Row ${currentRowNum}: Found 'TARGET' for "${storeName}", but subsequent row labels in THINGS column are incorrect or missing.`);
                    // Log the labels found in the THINGS column of the next 4 rows for debugging
                    console.warn(`[DEBUG PARSE]    Expected (THINGS column): INS - T, ACHIEVED, %, INS - Will Get!`);
                    console.warn(`[DEBUG PARSE]    Found (THINGS column, next 4 rows):`,
                                nextRows[0]?.[thingsIdx]?.toString().trim() || "Empty/Missing",
                                nextRows[1]?.[thingsIdx]?.toString().trim() || "Empty/Missing",
                                nextRows[2]?.[thingsIdx]?.toString().trim() || "Empty/Missing",
                                nextRows[3]?.[thingsIdx]?.toString().trim() || "Empty/Missing");

                    // Don't advance i by 4; let the loop check the next row as a potential block start
                }
            }
        } // End of loop through rows

         asms.sort((a, b) => a.localeCompare(b)); // Sort ASMs alphabetically
         // Sort stores within each ASM (optional but nice)
         for (const asm in parsedData) {
             if (parsedData.hasOwnProperty(asm)) {
                 const storesArray = Object.keys(parsedData[asm]).sort((a, b) => a.localeCompare(b));
                 const sortedStores = {};
                 storesArray.forEach(storeName => { sortedStores[storeName] = parsedData[asm][storeName]; });
                 parsedData[asm] = sortedStores;
             }
         }

         console.log(`[DEBUG PARSE] Parsing complete. Found ${asms.length} unique ASMs.`);
         if (asms.length === 0) {
             console.error("[DEBUG PARSE] No valid store blocks were identified according to the criteria.");
         }
    }


    // --- UI Selector Logic ---

     // Populates the ASM dropdown and sets up its change listener
    function updateAsmSelector() {
        const selector = document.getElementById('asmSelector');
        selector.innerHTML = `<option value="">-- Select ASM --</option>` + asms.map(a => `<option value="${a}">${a}</option>`).join('');
        selector.disabled = false;
        selector.removeEventListener('change', handleAsmChange);
        selector.addEventListener('change', handleAsmChange);

        updateStoreSelector([], ""); // Reset store selector
    }

     // Handles the change event on the ASM dropdown
    function handleAsmChange(event) {
         const selectedAsm = event.target.value;
         const storesForAsm = selectedAsm && parsedData[selectedAsm] ? Object.keys(parsedData[selectedAsm]).sort((a,b)=>a.localeCompare(b)) : [];
         updateStoreSelector(storesForAsm, selectedAsm); // Update the store selector based on the selected ASM
    }

    // Populates the Store dropdown (multi-select) and sets up its change listener
    function updateStoreSelector(storeList, selectedAsm) {
        const selector = document.getElementById('storeSelector');
        selector.removeEventListener('change', handleStoreChange); // Remove previous listener

        if (storeList.length > 0) {
             selector.innerHTML = storeList.map(s => `<option value="${s}">${s}</option>`).join('');
             selector.disabled = false;
             selector.size = Math.min(storeList.length, 10); // Adjust size to show more options (max 10)
             selector.addEventListener('change', handleStoreChange); // Add new listener
             selector._selectedAsm = selectedAsm; // Store selected ASM on the selector element

             clearDisplayAreas(false); // Clear previous display areas (charts, analysis)
        } else {
             // If no stores found for the selected ASM or no ASM selected
             selector.innerHTML = '<option value="">-- No Stores Available --</option>';
             selector.disabled = true;
             selector.size = 5; // Default size
             clearDisplayAreas(false); // Clear display areas
             document.getElementById('prediction').innerHTML = '<p class="text-center p-4 text-gray-500">Select an ASM with stores.</p>';
        }
    }

     // Handles the change event on the multi-select Store dropdown
    function handleStoreChange(event) {
         const selectedOptions = event.target.selectedOptions; // Get all selected <option> elements
         const selectedStores = Array.from(selectedOptions).map(option => option.value); // Extract values (store names)
         const selectedAsm = event.target._selectedAsm; // Retrieve the associated ASM name stored earlier

         // Hide/clear comparison and details initially
         document.getElementById('multi-store-comparison').classList.add('hidden');

         if (selectedAsm && selectedStores.length > 0) {
             // Display detailed view for the first selected store
             displayData(selectedAsm, selectedStores[0], selectedStores.length > 1); // Pass isMultipleSelected flag

             // Display multi-store comparison chart if more than one store is selected
             if (selectedStores.length > 1) {
                displayMultiStoreComparison(selectedAsm, selectedStores);
             }
         } else {
             // No store selected, or ASM is somehow lost (shouldn't happen if ASM is required)
             clearDisplayAreas(false); // Clear display but keep ASM selector state
              document.getElementById('prediction').innerHTML = '<p class="text-center p-4 text-gray-500">Select at least one store.</p>';
         }
     }


    // --- Data Display & Visualization ---

    // Displays all relevant data for the *first* selected store, handles multi-store comparison chart if needed
    function displayData(asm, store, isMultipleSelected = false) { // Added isMultipleSelected flag
        console.log(`Displaying details for Store: ${store} under ASM: ${asm}`);
         const data = parsedData[asm]?.[store]; // Safely access the data object

         if (!data?.ACHIEVED || !data?.TARGET || !data?.HEADERS?.length) {
             console.error(`Data invalid for ASM: ${asm}, Store: ${store}.`);
              clearDisplayAreas(false);
              document.getElementById('prediction').innerHTML = `<p class="text-center p-4 text-red-600 font-medium">Could not load data for "${store}" under ASM "${asm}". Data may be corrupted or incomplete.</p>`;
             setPerformanceBackground(null);
             return;
         }

        // Clean and validate extracted data arrays
        const allH = data.HEADERS;
        const allT = cleanData(data.TARGET);
        const allA = cleanData(data.ACHIEVED);
        const allIT = cleanData(data['INS - T']);
        const allIWG = cleanData(data['INS - Will Get!']);

        // Final check on array lengths matching header count after cleaning
        if (allH.length !== allT.length || allH.length !== allA.length || allH.length !== allIT.length || allH.length !== allIWG.length) {
             console.error(`Cleaned data array length mismatch for ${store}. Headers: ${allH.length}, Target: ${allT.length}, Achieved: ${allA.length}, Ins T: ${allIT.length}, Ins Will Get: ${allIWG.length}`);
             clearDisplayAreas(false);
              document.getElementById('prediction').innerHTML = `<p class="text-center p-4 text-red-600 font-medium">Data error for "${store}". Metric counts don't match across rows.</p>`;
             setPerformanceBackground(null);
             return;
        }

        // Calculate overall metrics
        const totalTarget = allT.reduce((s, v) => s + v, 0);
        const totalAchieved = allA.reduce((s, v) => s + v, 0);
        const overallPct = totalTarget > 0 ? (totalAchieved / totalTarget * 100) : (totalAchieved > 0 ? Infinity : 0); // Handle case where target is 0

        // Set dynamic background color based on overall performance
        setPerformanceBackground(overallPct);

        // Update KPI cards using metrics from the *first* selected store
        const analysisResult = updateCompAnalysis(totalTarget, totalAchieved, allT, allA, allIT, allIWG, allH, data.KAM || 'N/A', store);
        updateKPIs(overallPct, analysisResult.predPct, analysisResult.currInc);

        // Update Heatmap for the *first* selected store
        updateHeatmap(allH, allT, allA);

        // Filter data for the main charts (excluding UPI SALES)
        const chartH = [], chartT = [], chartA = [];
        allH.forEach((h, i) => {
            if (h && String(h).trim().toUpperCase() !== chartFilter.toUpperCase()) {
                 chartH.push(h);
                 chartT.push(allT[i]);
                 chartA.push(allA[i]);
            }
        });

        // Render main charts only if there's data after filtering
        if (chartH.length > 0) {
            renderComboChart(chartH, chartT, chartA);
            renderContribPieChart(chartH, chartA);
        } else {
            console.warn("No chart data available for main charts after filtering.");
            if (currentChart) { currentChart.destroy(); currentChart = null; }
            if (pieChartInstance) { pieChartInstance.destroy(); pieChartInstance = null; }
            // Keep display areas showing analysis/heatmap if they exist, just clear charts
        }

        // Show note if multiple stores are selected
        const noteEl = document.getElementById('selected-store-note');
        if(isMultipleSelected) {
            noteEl.textContent = `Detailed view shown for: ${store}. Use the comparison chart below.`;
            noteEl.classList.remove('hidden');
        } else {
            noteEl.classList.add('hidden');
        }


        // Update PDF export button handler with correct filename info
        document.getElementById('exportReport').onclick = () => exportReport(`${asm}_${store}`);
    }

    // Updates the KPI cards with overall, predicted, and incentive values
    function updateKPIs(overallPct, predPct, currInc) {
        const overallEl = document.getElementById('kpi-overall-achieved');
        const predEl = document.getElementById('kpi-predicted-achieved');
        const incEl = document.getElementById('kpi-incentive');

        // Update Overall Achievement
        overallEl.textContent = overallPct === Infinity ? '∞%' : overallPct.toFixed(1) + '%';
        overallEl.className = 'kpi-value ' + (overallPct === Infinity || overallPct >= 100 ? 'kpi-good' : overallPct >= 90 ? 'kpi-ok' : overallPct >= 60 ? 'kpi-warn' : 'kpi-alert');

        // Update Predicted Achievement
        predEl.textContent = predPct === Infinity ? '∞%' : predPct.toFixed(1) + '%';
        predEl.className = 'kpi-value ' + (predPct === Infinity || predPct >= 100 ? 'kpi-good' : predPct >= 90 ? 'kpi-ok' : predPct >= 60 ? 'kpi-warn' : 'kpi-alert');

        // Update Incentive
        incEl.textContent = currInc.toLocaleString();
        incEl.className = 'kpi-value ' + (currInc > 0 ? 'kpi-good' : 'kpi-warn');
    }

    // Provides detailed performance analysis and strategic insights for the *first* selected store
     function updateCompAnalysis(totalTarget, totalAchieved, targets, achieved, insTargets, insWillGets, headers, kam, storeName) { // Added storeName
         document.getElementById('analysis-store-name').textContent = `(for ${storeName})`; // Set store name in analysis title
         const predEl = document.getElementById('prediction'); // Predictions element

         // Calculate key metrics (Overall, Predictions, Incentives, Pace)
         const overallPct = totalTarget > 0 ? (totalAchieved / totalTarget * 100) : (totalAchieved > 0 ? Infinity : 0); // Overall % achievement

         const today=new Date(), dPassed=today.getDate(), totDays=new Date(today.getFullYear(),today.getMonth()+1,0).getDate(); // Month progress details
         const monthProg=(dPassed/totDays)*100; const dRemain=Math.max(1,totDays-dPassed); // Ensure > 0

         const currentRunRate=dPassed>0?totalAchieved/dPassed:0; // Average achieved per day so far
         const predictedFinal=Math.round(currentRunRate*totDays); // Simple month-end projection based on current rate
         const predictPct=totalTarget>0?(predictedFinal/totalTarget*100):(predictedFinal>0?Infinity:0); // Projected % achievement

         const remainingTarget=Math.max(0,totalTarget-totalAchieved); // Remaining value needed
         const neededDailyAvg=remainingTarget/dRemain; // Daily average needed for remaining days
         const neededDailyImprovement=Math.max(0, neededDailyAvg - currentRunRate); // How much *more* daily avg is needed

         const currentIncentive=insWillGets.reduce((s,v)=>s+v,0); // Sum of potential incentive values
         const targetIncentive=insTargets.reduce((s,v)=>s+v,0); // Sum of incentive targets
         const incGap = Math.max(0, targetIncentive - currentIncentive); // Incentive gap to target

         // Determine Executive Summary Status
         let status = "", sClass = "";
         if (predictPct === Infinity || predictPct >= 105) { status = `Exceeding Expectations! On track to significantly outperform the target.`; sClass = "bg-emerald-100 border-emerald-300 text-emerald-800"; }
         else if (predictPct >= 100) { status = `Solid Performance. On track to meet or slightly exceed target. Maintain momentum.`; sClass = "bg-emerald-100 border-emerald-300 text-emerald-800"; }
         else if (predictPct >= 90) { status = `Nearing Goal. Consistent final push required to hit the target.`; sClass = "bg-blue-100 border-blue-300 text-blue-800"; }
         else if (predictPct >= 75) { status = `Improvement Needed. Current pace likely to fall short of target. Focus on key areas.`; sClass = "bg-amber-100 border-amber-300 text-amber-800"; }
         else { status = `Critical Alert! Significant gap to target projection. Urgent intervention required.`; sClass = "bg-red-100 border-red-300 text-red-800"; }

         // Calculate metric-level performance for Top/Bottom lists
         const metricPerformance = headers.map((h, i) => ({
             n: h, p: targets[i] > 0 ? (achieved[i] / targets[i] * 100) : (achieved[i] > 0 ? Infinity : 0), // Percentage (handle 0 target)
             t: targets[i], a: achieved[i]
         }))
             .filter(m => (m.t > 0 || m.a > 0) && m.n && String(m.n).trim().toUpperCase() !== chartFilter.toUpperCase()) // Filter out empty/zero metrics and the excluded chart metric
             .sort((a, b) => (b.p === Infinity ? 9999 : b.p) - (a.p === Infinity ? 9999 : a.p)); // Sort descending by percentage (Infinity is highest)

         const topMetrics = metricPerformance.slice(0, Math.min(metricPerformance.length, 3)); // Get top N, up to number of available metrics
         const bottomMetrics = metricPerformance.slice(-Math.min(metricPerformance.length, 3)).reverse(); // Get bottom N, reversed

         // Build the HTML for the analysis section
         let analysisHTML = `<div class="space-y-5">`;

         // Executive Summary block
         analysisHTML += `<div class="exec-summary insight-block ${sClass}"><h4><svg class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>Overall Strategic Summary (${kam})</h4><p class="font-semibold">${status}</p></div>`;

         // Daily Pace Analysis
         analysisHTML += `<div class="insight-block bg-indigo-50 border-indigo-200">
                           <h4><svg class="h-5 w-5 text-indigo-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>Pacing Analysis: Month & Daily Rate</h4>
                           <ul class="metric-list text-sm !border-0">
                              <li><span>Month Progress:</span><strong>${monthProg.toFixed(0)}%</strong> (${dPassed}/${totDays})</li>
                              <li><span>Current Daily Avg:</span><strong>${currentRunRate.toLocaleString(undefined,{maximumFractionDigits:0})}</strong></li>
                              <li><span>Required Daily Avg:</span><strong class="${neededDailyAvg > currentRunRate ? 'text-red-600' : 'text-emerald-600'}">${neededDailyAvg.toLocaleString(undefined,{maximumFractionDigits:0})}</strong></li>
                            </ul>
                           <p class="advice">${neededDailyImprovement > 0 ? `Requires avg daily <strong class='text-red-600'>+${neededDailyImprovement.toLocaleString(undefined, {maximumFractionDigits:0})}</strong> over current pace to hit target.` : `Current pace <strong class='text-emerald-600'>sufficient</strong> if maintained.`}</p>
                        </div>`;

        // Incentive Motivation Section
        analysisHTML += `<div class="insight-block ${incGap > 0 ? 'bg-yellow-100 border-yellow-200 text-yellow-800' : 'bg-emerald-100 border-emerald-200 text-emerald-800'}">
                             <h4>💰 Incentive Target: Unlock Potential!</h4>
                              <p class="text-xl font-bold mb-2">Current Potential: <strong class="text-blue-700">${currentIncentive.toLocaleString()}</strong></p>
                             <p class="text-base">Towards Target: <strong class="text-lg">${targetIncentive.toLocaleString()}</strong></p>
                             ${incGap > 0
                                ? `<p class="advice mt-3">An <strong class="incentive-gap text-amber-700">${incGap.toLocaleString()}</strong> incentive gap exists! Boosting performance, especially in <strong class="font-semibold">Focus Areas</strong>, is crucial to close this gap and maximize earnings.</p>`
                                : `<p class="advice mt-3 font-semibold text-emerald-700">You are currently on track to meet or exceed your incentive target. Keep up the excellent performance to maximize your earnings!</p>`
                            }
                        </div>`;

        // Top Drivers & Focus Areas - side by side in a grid
        analysisHTML += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
        analysisHTML += `<div class="insight-block bg-green-50 border-green-200"><h4><svg class="h-5 w-5 text-emerald-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>Top Drivers (${topMetrics.length})</h4><ul class="metric-list">${topMetrics.map(m => `<li><span>${m.n}</span> <span class="percentage text-emerald-700">${m.p === Infinity ? '+Achieved' : (m.p === 0 && m.a > 0 ? '+Achieved' : m.p.toFixed(1)+'%')}</span></li>`).join('')}</ul><p class="advice text-sm mt-3">Identify and scale successful strategies here.</p></div>`;
        analysisHTML += `<div class="insight-block bg-red-50 border-red-200"><h4><svg class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>Focus Areas (${bottomMetrics.length})</h4><ul class="metric-list">${bottomMetrics.map(m => `<li><span>${m.n}</span> <span class="percentage text-red-700">${m.p === 0 && m.a === 0 ? '0%' : m.p.toFixed(1)+'%'}</span></li>`).join('')}</ul><p class="advice text-sm mt-3">Requires immediate action & targeted plans.</p></div>`;
        analysisHTML+=`</div>`; // Close inner grid

        analysisHTML+=`</div>`; // Close main space-y-5 div
        predEl.innerHTML = analysisHTML; // Set the generated HTML

        // Return metrics needed by other functions (KPIs, PDF export name)
        return { predPct: predictPct, currInc: currentIncentive };
     }


    // Updates the heatmap table showing metric performance details for the first selected store
    function updateHeatmap(hdrs,tgts,achs){const heatEl=document.getElementById('heatmap');let table='<table class="w-full text-sm border-collapse">';table+='<thead><tr class="bg-gray-200 text-left text-xs text-gray-600 uppercase tracking-wider font-semibold"><th class="p-2 border border-gray-300 sticky top-0 bg-gray-200 z-10">Metric</th><th class="p-2 border border-gray-300 text-center sticky top-0 bg-gray-200 z-10">Ach%</th><th class="p-2 border border-gray-300 tr sticky top-0 bg-gray-200 z-10">Achieved</th><th class="p-2 border border-gray-300 tr sticky top-0 bg-gray-200 z-10">Target</th></tr></thead><tbody>';hdrs.forEach((m,i)=>{const t=tgts[i],a=achs[i],p=t>0?(a/t*100):(a>0?Infinity:0);const pDisp=(p===Infinity)?'N/A':(p===0 && a===0 ? '0%' : (p===0 && a>0 ? '+Achieved' : p.toFixed(0)+'%')),clr=getHeatmapClr(p);table+=`<tr class="hover:bg-gray-100"><td class="p-2 border border-gray-200 font-medium text-gray-800">${m}</td><td class="p-1 border border-gray-200 text-center font-bold text-xs rounded-md mx-auto my-0.5" style="background-color:${clr.bg};color:${clr.text};width:60px;display:block;">${pDisp}</td><td class="p-2 border border-gray-200 text-right">${a.toLocaleString()}</td><td class="p-2 border border-gray-200 text-right text-gray-500">${t.toLocaleString()}</td></tr>`;});table+='</tbody></table>';heatEl.innerHTML=table;}

    // Renders the combination Bar/Line chart for the *first* selected store
    function renderComboChart(labels, targets, achieveds) {
        const ctx = document.getElementById('comboChart').getContext('2d');
        if (currentChart) { currentChart.destroy(); } // Destroy previous instance

        const data = { labels: labels, datasets: [{ label: 'ACHIEVED', data: achieveds, type: 'bar', backgroundColor: createGradient(ctx, 'rgba(16, 185, 129, 0.75)', 'rgba(6, 182, 212, 0.75)'), borderColor: 'rgba(4, 120, 87, 0.8)', borderWidth: 1, borderRadius: 3, order: 2, barPercentage: 0.7, categoryPercentage: 0.6 },{ label: 'TARGET', data: targets, type: 'line', borderColor: 'rgba(79, 70, 229, 1)', backgroundColor: 'rgba(99, 102, 241, 0.1)', borderWidth: 3, pointStyle: 'circle', pointRadius: 4.5, pointHoverRadius: 7, pointBackgroundColor: 'rgba(79, 70, 229, 1)', tension: 0.1, fill: true, order: 1 }]};

        currentChart = new Chart(ctx, {
            data: data, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false, axis: 'x' }, hover: { mode: 'nearest', intersect: true, axis: 'x' },
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20, font: { size: 11 }, usePointStyle: true } }, title: { display: false },
                 datalabels: { display: 'auto', color: (c) => c.dataset.type === 'line' ? '#4338ca' : '#065f46', anchor: 'end', align: 'end', offset: (c) => c.dataset.type === 'line' ? 6 : -4, font: { weight: 'bold', size: 9 }, formatter: (v) => v>0 ? v.toLocaleString(undefined,{notation:'compact',compactDisplay:'short'}):null},
                 tooltip: { enabled: true, external: externalTooltipHandler }
            }, scales: { x: { grid: { display: false }, ticks: { font: { size: 10.5 } } }, y: { beginAtZero: true, grid: { color: '#e5e7eb', drawBorder: false }, ticks: { callback: (v) => v>999?(v/1000).toFixed(v%1000!==0?1:0)+'k':v.toLocaleString(), font: { size: 10.5 }, maxTicksLimit: 7}, title: { display: true, text: 'Value', font: { size: 12}, padding:{bottom:8}}}}
            ,animation: { duration: 700, easing: 'easeOutCubic' } }, plugins: [ChartDataLabels] });
    }

     // Renders the contribution Pie (Doughnut) chart for the *first* selected store
     function renderContribPieChart(labels, achievedData) {
         const pieCtx = document.getElementById('pieChart').getContext('2d');
         if (pieChartInstance) { pieChartInstance.destroy(); }

        const filteredData = labels.map((label, index) => ({ label, value: achievedData[index] })).filter(item => item.value > 0);
        const pieLabels = filteredData.map(item => item.label);
        const pieValues = filteredData.map(item => item.value);
        const bgClrs = ['#a3e635','#34d399','#22d3ee','#818cf8','#c084fc','#f472b6','#fb7185','#fbbf24','#facc15','#4ade80','#60a5fa','#f9a8d4'];

        pieChartInstance = new Chart(pieCtx, { type: 'doughnut', data: { labels: pieLabels, datasets:[{data: pieValues, backgroundColor: bgClrs.slice(0, pieLabels.length), borderColor:'#ffffff', borderWidth:2.5, hoverOffset:8}]},
             options: { responsive:true, maintainAspectRatio:false, cutout:'60%',
                 plugins:{ legend:{ position:'bottom', labels:{ boxWidth:12, padding:15, font:{size:10.5} } }, title:{display:false},
                     tooltip:{enabled:true, external: externalTooltipHandler},
                     datalabels:{ formatter: (v,c)=>{const t=c.chart.getDatasetMeta(0).total||1,p=(v/t*100);return p>4?p.toFixed(0)+'%':'';}, color:'#1f2937', font:{weight:'bold', size:10}, anchor:'end', align:'end', offset:8} } }, plugins:[ChartDataLabels]});
    }

    // Displays the multi-store comparison chart
    function displayMultiStoreComparison(asm, stores) {
        const comparisonData = stores.map(store => {
            const data = parsedData[asm][store];
            const allT = cleanData(data.TARGET);
            const allA = cleanData(data.ACHIEVED);
            const totalTarget = allT.reduce((s, v) => s + v, 0);
            const totalAchieved = allA.reduce((s, v) => s + v, 0);
            const overallPct = totalTarget > 0 ? (totalAchieved / totalTarget * 100) : (totalAchieved > 0 ? Infinity : 0);
            return { store, overallPct };
        });

        document.getElementById('multi-store-comparison').classList.remove('hidden');
        renderMultiStoreComparisonChart(comparisonData);
    }

     // Renders the comparison chart for multiple selected stores
     function renderMultiStoreComparisonChart(comparisonData) {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        if (comparisonChartInstance) { comparisonChartInstance.destroy(); } // Destroy previous instance

        const labels = comparisonData.map(item => item.store);
        const dataValues = comparisonData.map(item => item.overallPct === Infinity ? 1000 : item.overallPct); // Cap Infinity for display
        const bgColors = comparisonData.map(item => {
            const pct = item.overallPct;
            if (pct === Infinity || pct >= 100) return 'rgba(16, 185, 129, 0.7)';
            if (pct >= 90) return 'rgba(59, 130, 246, 0.7)';
            if (pct >= 60) return 'rgba(245, 158, 11, 0.7)';
            return 'rgba(239, 68, 68, 0.7)';
        });

        comparisonChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Achievement %',
                    data: dataValues,
                    backgroundColor: bgColors,
                    borderColor: bgColors.map(c => c.replace('0.7', '1')),
                    borderWidth: 1,
                    borderRadius: 4,
                    barPercentage: 0.85,
                    categoryPercentage: 0.9
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        external: externalTooltipHandler,
                        callbacks: {
                            label: (ctx) => {
                                const pct = comparisonData[ctx.dataIndex].overallPct;
                                return `${ctx.dataset.label}: ${pct === Infinity ? '∞%' : pct.toFixed(1) + '%'}`;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        offset: -4,
                        font: { weight: 'bold', size: 10 },
                        formatter: (v, ctx) => {
                            const pct = comparisonData[ctx.dataIndex].overallPct;
                            return pct === Infinity ? '∞%' : pct.toFixed(1) + '%';
                        },
                        color: '#1f2937'
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 10.5 }, maxRotation: 45, minRotation: 0 }
                    },
                    y: {
                        beginAtZero: true,
                        max: Math.max(100, ...dataValues.filter(v => v !== 1000)) * 1.1,
                        grid: { color: '#e5e7eb' },
                        ticks: {
                            callback: (v) => v >= 1000 ? '∞%' : v.toFixed(0) + '%',
                            font: { size: 10.5 },
                            maxTicksLimit: 8
                        },
                        title: { display: true, text: 'Achievement %', font: { size: 12 }, padding: { bottom: 8 } }
                    }
                },
                animation: { duration: 700, easing: 'easeOutCubic' }
            },
            plugins: [ChartDataLabels]
        });
    }

    // Exports the dashboard as a PDF
    function exportReport(filenamePrefix) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'px', format: 'a4' });
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        const margin = 20;
        let yOffset = margin;

        // Title
        doc.setFont('Inter', 'bold');
        doc.setFontSize(18);
        doc.setTextColor(17, 24, 39);
        doc.text('Executive Store Performance Report', pageWidth / 2, yOffset, { align: 'center' });
        yOffset += 30;

        // Capture dashboard sections
        const sections = [
            { id: 'kpi-overall-achieved', label: 'Overall Achievement' },
            { id: 'kpi-predicted-achieved', label: 'Predicted Achievement' },
            { id: 'kpi-incentive', label: 'Current Incentive' },
            { id: 'comboChart', label: 'Core Metrics Performance', isCanvas: true },
            { id: 'pieChart', label: 'Contribution Mix', isCanvas: true },
            { id: 'heatmap', label: 'Achievement Details' },
            { id: 'prediction', label: 'Performance Analysis' }
        ];

        if (!document.getElementById('multi-store-comparison').classList.contains('hidden')) {
            sections.push({ id: 'comparisonChart', label: 'Multi-Store Comparison', isCanvas: true });
        }

        const promises = sections.map(section => {
            const element = document.getElementById(section.id).closest('.card') || document.getElementById(section.id);
            if (!element) return Promise.resolve(null);

            return html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = pageWidth - 2 * margin;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                return { imgData, imgWidth, imgHeight, label: section.label };
            }).catch(err => {
                console.error(`Failed to capture ${section.label}:`, err);
                return null;
            });
        });

        Promise.all(promises).then(images => {
            images.filter(img => img !== null).forEach((img, index) => {
                if (yOffset + img.imgHeight + 40 > pageHeight) {
                    doc.addPage();
                    yOffset = margin;
                }

                doc.setFontSize(14);
                doc.setTextColor(55, 65, 81);
                doc.text(img.label, margin, yOffset);
                yOffset += 20;

                doc.addImage(img.imgData, 'PNG', margin, yOffset, img.imgWidth, img.imgHeight);
                yOffset += img.imgHeight + 20;

                if (index === images.length - 1) {
                    doc.setFontSize(10);
                    doc.setTextColor(100, 116, 139);
                    doc.text(`Generated on ${new Date().toLocaleString()}`, margin, pageHeight - margin);
                }
            });

            doc.save(`${filenamePrefix}_Performance_Report.pdf`);
        }).catch(err => {
            console.error('PDF generation failed:', err);
            alert('Failed to generate PDF. Check console for details.');
        });
    }

    // Initialize
    document.getElementById('exportReport').onclick = () => alert('Load data and select a store to export.');
    clearDisplayAreas(true);
  </script>
</body>
</html>